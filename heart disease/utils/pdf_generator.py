"""
PDF Report Generator
Creates doctor-friendly PDF reports with predictions, graphs, and recommendations
"""

from reportlab.lib.pagesizes import letter, A4
from reportlab.lib import colors
from reportlab.lib.units import inch
from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, PageBreak
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.enums import TA_CENTER, TA_LEFT, TA_RIGHT
from datetime import datetime
import matplotlib.pyplot as plt
from io import BytesIO
from reportlab.lib.utils import ImageReader
import warnings
warnings.filterwarnings('ignore')


class PDFReportGenerator:
    """Generate PDF reports for predictions"""
    
    def __init__(self):
        self.styles = getSampleStyleSheet()
        self._setup_custom_styles()
    
    def _setup_custom_styles(self):
        """Setup custom paragraph styles"""
        self.title_style = ParagraphStyle(
            'CustomTitle',
            parent=self.styles['Heading1'],
            fontSize=24,
            textColor=colors.HexColor('#1f4788'),
            spaceAfter=30,
            alignment=TA_CENTER
        )
        
        self.heading_style = ParagraphStyle(
            'CustomHeading',
            parent=self.styles['Heading2'],
            fontSize=16,
            textColor=colors.HexColor('#2c5aa0'),
            spaceAfter=12,
            spaceBefore=12
        )
        
        self.body_style = ParagraphStyle(
            'CustomBody',
            parent=self.styles['Normal'],
            fontSize=11,
            spaceAfter=12,
            leading=14
        )
    
    def generate_report(self, filename, patient_data, prediction_result,
                       risk_assessment, recommendations, model_info=None):
        """Generate comprehensive PDF report"""
        doc = SimpleDocTemplate(filename, pagesize=letter)
        story = []
        
        # Title
        title = Paragraph("Heart Disease Risk Assessment Report", self.title_style)
        story.append(title)
        story.append(Spacer(1, 0.2*inch))
        
        # Report metadata
        report_date = datetime.now().strftime("%B %d, %Y")
        date_para = Paragraph(f"<b>Report Date:</b> {report_date}", self.body_style)
        story.append(date_para)
        story.append(Spacer(1, 0.1*inch))
        
        # Disclaimer
        disclaimer = Paragraph(
            "<b>IMPORTANT DISCLAIMER:</b><br/>"
            "This report is generated by an automated system for educational and research purposes only. "
            "It does not replace professional medical diagnosis, treatment, or advice. "
            "Always consult with qualified healthcare professionals for medical decisions.",
            ParagraphStyle(
                'Disclaimer',
                parent=self.body_style,
                textColor=colors.red,
                fontSize=9,
                borderPadding=10,
                backColor=colors.HexColor('#fff3cd')
            )
        )
        story.append(disclaimer)
        story.append(Spacer(1, 0.3*inch))
        
        # Patient Information Section
        story.append(Paragraph("Patient Information", self.heading_style))
        patient_table_data = [
            ['Parameter', 'Value'],
            ['Age', str(patient_data.get('age', 'N/A'))],
            ['Sex', 'Male' if patient_data.get('sex') == 1 else 'Female'],
            ['Blood Pressure', f"{patient_data.get('bp_systolic', 'N/A')}/{patient_data.get('bp_diastolic', 'N/A')} mmHg"],
            ['Cholesterol', f"{patient_data.get('cholesterol', 'N/A')} mg/dL"],
            ['HDL Cholesterol', f"{patient_data.get('hdl', 'N/A')} mg/dL"],
            ['BMI', f"{patient_data.get('bmi', 'N/A'):.1f}" if patient_data.get('bmi') else 'N/A'],
            ['Smoking Status', 'Yes' if patient_data.get('smoking') == 1 else 'No'],
            ['Diabetes', 'Yes' if patient_data.get('diabetes') == 1 else 'No']
        ]
        
        patient_table = Table(patient_table_data, colWidths=[3*inch, 3*inch])
        patient_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#2c5aa0')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('GRID', (0, 0), (-1, -1), 1, colors.black),
            ('FONTSIZE', (0, 1), (-1, -1), 10),
            ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.HexColor('#f5f5f5')])
        ]))
        story.append(patient_table)
        story.append(Spacer(1, 0.3*inch))
        
        # Prediction Results Section
        story.append(Paragraph("Prediction Results", self.heading_style))
        
        prediction_prob = prediction_result.get('probability', 0) * 100
        prediction_label = "High Risk" if prediction_result.get('prediction', 0) == 1 else "Low Risk"
        
        prediction_data = [
            ['Metric', 'Value'],
            ['Prediction', prediction_label],
            ['Risk Probability', f"{prediction_prob:.2f}%"],
            ['Risk Category', risk_assessment.get('category', 'N/A')],
            ['Model Used', model_info.get('model_name', 'Ensemble') if model_info else 'Ensemble']
        ]
        
        # Color code based on risk
        bg_color = colors.red if prediction_prob >= 50 else colors.orange if prediction_prob >= 20 else colors.green
        
        prediction_table = Table(prediction_data, colWidths=[3*inch, 3*inch])
        prediction_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#2c5aa0')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), bg_color),
            ('TEXTCOLOR', (0, 1), (-1, -1), colors.white),
            ('GRID', (0, 0), (-1, -1), 1, colors.black),
            ('FONTSIZE', (0, 1), (-1, -1), 11),
            ('FONTNAME', (0, 1), (-1, -1), 'Helvetica-Bold')
        ]))
        story.append(prediction_table)
        story.append(Spacer(1, 0.3*inch))
        
        # Risk Assessment Section
        story.append(Paragraph("Risk Assessment", self.heading_style))
        risk_text = Paragraph(
            f"<b>Risk Level:</b> {risk_assessment.get('category', 'N/A')}<br/>"
            f"<b>Risk Score:</b> {risk_assessment.get('risk_percentage', 0):.1f}%<br/><br/>"
            f"<b>Recommendation:</b> {risk_assessment.get('recommendation', 'N/A')}",
            self.body_style
        )
        story.append(risk_text)
        story.append(Spacer(1, 0.3*inch))
        
        # Recommendations Section
        story.append(Paragraph("Recommendations", self.heading_style))
        
        if recommendations:
            for category, items in recommendations.items():
                if isinstance(items, list) and items:
                    story.append(Paragraph(f"<b>{category.replace('_', ' ').title()}:</b>", 
                                         ParagraphStyle('SubHeading', parent=self.body_style, fontSize=12)))
                    
                    for item in items[:5]:  # Limit to top 5 per category
                        if isinstance(item, dict):
                            rec_text = item.get('recommendations', [])
                            if rec_text:
                                for rec in rec_text[:3]:  # Top 3 recommendations
                                    story.append(Paragraph(f"• {rec}", self.body_style))
                        elif isinstance(item, str):
                            story.append(Paragraph(f"• {item}", self.body_style))
                    
                    story.append(Spacer(1, 0.1*inch))
        
        story.append(Spacer(1, 0.2*inch))
        
        # Monitoring Recommendations
        story.append(Paragraph("Monitoring Plan", self.heading_style))
        monitoring_text = Paragraph(
            "• Monitor blood pressure regularly<br/>"
            "• Schedule regular cardiovascular screenings<br/>"
            "• Track cholesterol levels every 3-6 months<br/>"
            "• Maintain regular follow-ups with healthcare provider",
            self.body_style
        )
        story.append(monitoring_text)
        story.append(Spacer(1, 0.3*inch))
        
        # Footer
        footer = Paragraph(
            "<i>This report was generated by the Heart Disease Prediction System. "
            "For questions or concerns, please consult with your healthcare provider.</i>",
            ParagraphStyle('Footer', parent=self.body_style, fontSize=9, textColor=colors.grey, alignment=TA_CENTER)
        )
        story.append(footer)
        
        # Build PDF
        doc.build(story)
        return filename
    
    def add_image_to_report(self, image_path, caption=""):
        """Add an image to the report"""
        # This would be used if we want to add charts/graphs
        # Implementation would depend on specific requirements
        pass

